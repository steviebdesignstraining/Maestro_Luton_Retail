name: Android UI Tests with Maestro

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  maestro-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download APK from GitHub Release
        uses: dsaltares/fetch-gh-release-asset@master
        with:
          repo: steviebdesignstraining/Maestro_Luton_Retail
          version: 'v1.0.0'                            # âœ… Must include 'v'
          file: LutonRetail.apk
          token: ${{ secrets.GITHUB_TOKEN }}
          target: app.apk

      - name: Prepare flow file
        run: |
          mkdir maestro-workspace
          cp Maestro/flow_android.yaml maestro-workspace/

      - name: Run Maestro test on Maestro Cloud
        uses: mobile-dev-inc/action-maestro-cloud@v1
        with:
          app-file: app.apk
          project-id: ${{ secrets.LUTON_RETAIL }}
          workspace: maestro-workspace

      - name: Upload Maestro Test Output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-test-output
          path: .maestro/output/
